generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Roles {
  Admin
  User
}

enum ActionType {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
}

enum EntityType {
  USER
  HYMN
  CATEGORY
  VERSE
  CHORUS
  SOLFA_IMAGE
}

enum UserStatus {
  Active
  Inactive
}

enum HymnStatus {
  Published
  Draft
  UnderReview
  Archived
}

model User {
  id         String     @id @default(uuid()) @db.Uuid
  firstName  String
  lastName   String
  email      String     @unique
  password   String
  role       Roles      @default(User)
  status     UserStatus @default(Active)
  createdAt  DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime   @updatedAt() @db.Timestamptz(6)
  deletedAt  DateTime?  @db.Timestamptz(6)

  // Relationships
  hymnsCreated      Hymn[]      @relation("UserCreatedHymns")
  hymnsUpdated      Hymn[]      @relation("UserUpdatedHymns")
  categoriesCreated Category[]  @relation("UserCreatedCategories")
  categoriesUpdated Category[]  @relation("UserUpdatedCategories")
  versesCreated     Verse[]     @relation("UserCreatedVerses")
  versesUpdated     Verse[]     @relation("UserUpdatedVerses")
  chorusesCreated   Chorus[]    @relation("UserCreatedChoruses")
  chorusesUpdated   Chorus[]    @relation("UserUpdatedChoruses")
  solfaImagesCreated SolfaImage[] @relation("UserCreatedSolfaImages")
  solfaImagesUpdated SolfaImage[] @relation("UserUpdatedSolfaImages")

  auditLogs  AuditLog[]

  @@index([email])
  @@map("users")
}

model Hymn {
  id          String       @id @default(uuid()) @db.Uuid
  number      Int?         @unique
  title       String
  slug        String       @unique
  category    Category?    @relation(fields: [categoryId], references: [id])
  categoryId  String?      @db.Uuid
  author      String?
  language    String?
  version     String?
  verses      Verse[]      @relation("HymnVerses")
  choruses    Chorus[]     @relation("HymnChoruses")
  solfaImages SolfaImage[] @relation("HymnSolfaImages")
  status      HymnStatus   @default(Published)

  createdBy   User?        @relation("UserCreatedHymns", fields: [createdById], references: [id])
  createdById String?      @db.Uuid
  updatedBy   User?        @relation("UserUpdatedHymns", fields: [updatedById], references: [id])
  updatedById String?      @db.Uuid

  createdAt   DateTime     @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime     @updatedAt() @db.Timestamptz(6)
  deletedAt   DateTime?    @db.Timestamptz(6)

  @@index([title])
  @@index([number])
  @@index([deletedAt])
  @@index([categoryId])
  @@map("hymns")
}

model Category {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  slug        String    @unique
  hymns       Hymn[]

  createdBy   User?     @relation("UserCreatedCategories", fields: [createdById], references: [id])
  createdById String?   @db.Uuid
  updatedBy   User?     @relation("UserUpdatedCategories", fields: [updatedById], references: [id])
  updatedById String?   @db.Uuid

  createdAt   DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt() @db.Timestamptz(6)
  deletedAt   DateTime? @db.Timestamptz(6)

  @@index([name])
  @@map("categories")
}

model Chorus {
  id          String    @id @default(uuid()) @db.Uuid
  text        String
  description String?   @db.Text
  hymn        Hymn      @relation("HymnChoruses", fields: [hymnId], references: [id])
  hymnId      String    @db.Uuid

  createdBy   User?     @relation("UserCreatedChoruses", fields: [createdById], references: [id])
  createdById String?   @db.Uuid
  updatedBy   User?     @relation("UserUpdatedChoruses", fields: [updatedById], references: [id])
  updatedById String?   @db.Uuid

  createdAt   DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt() @db.Timestamptz(6)
  deletedAt   DateTime? @db.Timestamptz(6)

  @@map("choruses")
}

model Verse {
  id          String    @id @default(uuid()) @db.Uuid
  text        String
  order       Int?
  hymn        Hymn      @relation("HymnVerses", fields: [hymnId], references: [id])
  hymnId      String    @db.Uuid

  createdBy   User?     @relation("UserCreatedVerses", fields: [createdById], references: [id])
  createdById String?   @db.Uuid
  updatedBy   User?     @relation("UserUpdatedVerses", fields: [updatedById], references: [id])
  updatedById String?   @db.Uuid

  createdAt   DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt() @db.Timestamptz(6)
  deletedAt   DateTime? @db.Timestamptz(6)

  @@map("verses")
}

model SolfaImage {
  id          String    @id @default(uuid()) @db.Uuid
  imageUrl    String
  hymn        Hymn      @relation("HymnSolfaImages", fields: [hymnId], references: [id])
  hymnId      String    @db.Uuid

  createdBy   User?     @relation("UserCreatedSolfaImages", fields: [createdById], references: [id])
  createdById String?   @db.Uuid
  updatedBy   User?     @relation("UserUpdatedSolfaImages", fields: [updatedById], references: [id])
  updatedById String?   @db.Uuid

  createdAt   DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt() @db.Timestamptz(6)
  deletedAt   DateTime? @db.Timestamptz(6)

  @@map("solfa_images")
}

model AuditLog {
  id         String     @id @default(uuid()) @db.Uuid
  action     ActionType
  entityType EntityType
  entityId   String?
  details    Json?
  ipAddress  String?
  userAgent  String?

  user       User       @relation(fields: [userId], references: [id])
  userId     String     @db.Uuid

  createdAt  DateTime   @default(now())

  @@map("audit_logs")
}
